#!/usr/bin/env ruby -w

require 'English'
require 'fileutils'

if __FILE__ == $PROGRAM_NAME
	FileUtils.mkdir_p('build')
	FileUtils.cp_r('choices', 'build')
	FileUtils.rm_r('choices')
	
	choices = {
		:readmeext => '{{readmeext|default: '.rst'}}',
		:license => '{{license|default: 'Apache-2.0'}}',
		:buildtool => '{{buildtool|default: 'rake'}}',
		:testfrwk => '{{testfrwk|default: 'rspec'}}',
		:executable => '{{executable|default: 'no'}}',
		:ffilib => '{{ffilib|default: 'none'}}'
		}
	nesteddirs = "{{nesteddirs|default: 'introrb/util'}}"
	parent = "{{parent|default: 'introrb'}}"
	project = "{{project|default: 'util'}}"
	
	FileUtils.cp("build/choices/readme/README#{choices[:readmeext]}", 
		"README#{choices[:readmeext]}")
	if File.exist?('build/choices/_parent_readme')
		FileUtils.cp("build/choices/_parent_readme/README#{choices[:readmeext]}",
			"build/choices/_parent_init/README#{choices[:readmeext]}")
	end
	
	if ['Apache-2.0', 'MIT', 'BSD-3-Clause', 'GPL-3.0+', 'ISC', 'Unlicense'
			].include?(choices[:license])
		FileUtils.cp("build/choices/license/LICENSE_#{choices[:license]}", 'LICENSE')
	end
	
	if File.exist?('build/choices/build_tool') and ['rake', 'make'].include?(
            choices[:buildtool])
		FileUtils.cp_r("build/choices/build_tool/#{choices[:buildtool]}/.", '.')
	elsif File.exist?('build/choices/build_tool') # default: rake
		FileUtils.cp_r('build/choices/build_tool/rake/.', '.')
	end
	
	if File.exist?('build/choices/testfrwk') and ['rspec', 'minitest',
			'minitest-spec'].include?(choices[:testfrwk])
		FileUtils.cp_r("build/choices/testfrwk/#{choices[:testfrwk]}/.", ".")
	elsif File.exist?('build/choices/testfrwk') # default: rspec
		FileUtils.cp_r('build/choices/testfrwk/rspec/.', ".")
	end
	
	if File.exist?("bin") and File.exist?("lib/#{nesteddirs}") and 
			not 'yes' == choices[:executable]
		Dir["bin/#{parent}_#{project}", "lib/#{nesteddirs}/cli.rb",
			"lib/#{nesteddirs}/app.rb"].each{|p| FileUtils.rm(p)}
	end
	
	if File.exist?('build/choices/ffi_lib') and ['ffi', 'swig'].include?(choices[:ffilib])
		if 'swig' == choices[:ffilib]
			FileUtils.cp_r("build/choices/ffi_lib/#{choices[:ffilib]}/.", "ext/")
		else
			FileUtils.cp_r("build/choices/ffi_lib/#{choices[:ffilib]}/.",
				"lib/#{nesteddirs}/")
		end
	end
	
	if File.exist?('../_templates') and File.directory?('../_templates')
		skeletondir = {%if skeletondir%}'{{skeletondir}}' # {%endif%}'#{ENV["HOME"]}/Templates/liquid/skeleton-rb'
		skel_pardir = File.dirname(skeletondir)
		
		FileUtils.mkdir_p('../_templates/liquid')
		(Dir["#{skel_pardir}/render_liquid.*"]+[skeletondir]).each{|src|
			FileUtils.cp_r(src, '../_templates/liquid/')}
	end
end
